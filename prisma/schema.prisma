generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String
  password        String
  role            String   @default("user") // user, admin
  profileImage    String?  @db.Text
  empresaActivaId String?
  empresaActiva   Empresa? @relation(fields: [empresaActivaId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Cliente {
  id              String        @id @default(cuid())
  nombre          String
  apellido        String
  email           String        @unique
  telefono        String
  direccion       String
  cedula          String        @unique
  password        String?
  fechaNacimiento DateTime
  empresaId       String
  empresa         Empresa       @relation(fields: [empresaId], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  creditos        Credito[]
  evaluaciones    Evaluacion[]
}

model Credito {
  id                      String                @id @default(cuid())
  monto                   Float
  tasaInteres             Float
  plazoMeses              Int
  cuotaMensual            Float
  montoPagado             Float                 @default(0)
  estado                  String                @default("borrador") // borrador, validado, activo, pagado, vencido
  tokenPublico            String?               @unique // Token para compartir URL pública de aprobación
  estadoAprobacion        String?               // pendiente, aprobado, rechazado
  fechaRespuesta          DateTime?             // Fecha de aprobación/rechazo
  fechaInicio             DateTime              @default(now())
  fechaVencimiento        DateTime
  clienteId               String
  cliente                 Cliente               @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  configuracionCreditoId  String
  configuracionCredito    ConfiguracionCredito  @relation(fields: [configuracionCreditoId], references: [id])
  empresaId               String
  empresa                 Empresa               @relation(fields: [empresaId], references: [id])
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  pagos                   Pago[]
  cuotas                  Cuota[]
}

model Pago {
  id          String   @id @default(cuid())
  monto       Float
  fechaPago   DateTime @default(now())
  metodoPago  String   // efectivo, transferencia, tarjeta
  tipoPago    String   @default("cuotas") // cuotas, aporte_capital
  creditoId   String
  credito     Credito  @relation(fields: [creditoId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

model Empresa {
  id             String   @id @default(cuid())
  nombre         String
  logo           String?  @db.Text
  moneda         String   @default("EUR") // EUR, USD, etc.
  color          String   @default("#2563eb") // Color principal de la interfaz
  usuarios       User[]
  clientes       Cliente[]
  creditos       Credito[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ConfiguracionCredito {
  id            String    @id @default(cuid())
  nombre        String
  interesAnual  Float
  tipoCalculo   String    @default("frances") // frances, aleman, americano
  creditos      Credito[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Cuota {
  id                String   @id @default(cuid())
  numeroCuota       Int
  fechaVencimiento  DateTime
  montoCuota        Float
  capital           Float
  interes           Float
  balanceInicial    Float
  balanceFinal      Float
  pagado            Boolean  @default(false)
  fechaPago         DateTime?
  creditoId         String
  credito           Credito  @relation(fields: [creditoId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Evaluacion {
  id                        String   @id @default(cuid())
  ingresosMensuales         Float
  gastosMensuales           Float
  capacidadEndeudamiento    Float
  porcentajeEndeudamiento   Float    @default(40) // Porcentaje de ingresos disponible para deuda
  clienteId                 String
  cliente                   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model MedioPago {
  id        String   @id @default(cuid())
  nombre    String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
