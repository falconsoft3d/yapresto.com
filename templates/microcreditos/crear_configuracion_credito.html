{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}
{% block page_title %}Nueva Configuración de Crédito{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .preview-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
    }
    .calculator-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
</style>
{% endblock %}

{% block dashboard_content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-plus-circle me-2"></i>{{ titulo }}
        </h1>
        <p class="text-muted mb-0">Configure los parámetros para nuevos créditos del sistema</p>
        </div>
        <a href="{% url 'microcreditos:configuracion_credito' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>

    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Formulario Principal -->
            <div class="col-lg-8">
                <!-- Información General -->
                <div class="form-section">
                    <h4 class="section-title">
                        <i class="fas fa-info-circle me-2"></i>Información General
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label required">
                                    {{ form.nombre.label }}
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.help_text %}
                                <div class="help-text">{{ form.nombre.help_text }}</div>
                                {% endif %}
                                {% if form.nombre.errors %}
                                <div class="invalid-feedback d-block">{{ form.nombre.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.activa.id_for_label }}" class="form-label">
                                    {{ form.activa.label }}
                                </label>
                                <div class="form-check form-switch">
                                    {{ form.activa }}
                                    <label class="form-check-label" for="{{ form.activa.id_for_label }}">
                                        Activar esta configuración
                                    </label>
                                </div>
                                {% if form.activa.help_text %}
                                <div class="help-text">{{ form.activa.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                            {{ form.descripcion.label }}
                        </label>
                        {{ form.descripcion }}
                        {% if form.descripcion.help_text %}
                        <div class="help-text">{{ form.descripcion.help_text }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Configuración de Interés -->
                <div class="form-section">
                    <h4 class="section-title">
                        <i class="fas fa-percentage me-2"></i>Configuración de Interés
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.interes_anual.id_for_label }}" class="form-label required">
                                    {{ form.interes_anual.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.interes_anual }}
                                    <span class="input-group-text">%</span>
                                </div>
                                {% if form.interes_anual.help_text %}
                                <div class="help-text">{{ form.interes_anual.help_text }}</div>
                                {% endif %}
                                {% if form.interes_anual.errors %}
                                <div class="invalid-feedback d-block">{{ form.interes_anual.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.tipo_calculo.id_for_label }}" class="form-label required">
                                    {{ form.tipo_calculo.label }}
                                </label>
                                {{ form.tipo_calculo }}
                                {% if form.tipo_calculo.help_text %}
                                <div class="help-text">{{ form.tipo_calculo.help_text }}</div>
                                {% endif %}
                                {% if form.tipo_calculo.errors %}
                                <div class="invalid-feedback d-block">{{ form.tipo_calculo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Límites de Monto -->
                <div class="form-section">
                    <h4 class="section-title">
                        <i class="fas fa-dollar-sign me-2"></i>Límites de Monto
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.monto_minimo.id_for_label }}" class="form-label required">
                                    {{ form.monto_minimo.label }}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.monto_minimo }}
                                </div>
                                {% if form.monto_minimo.help_text %}
                                <div class="help-text">{{ form.monto_minimo.help_text }}</div>
                                {% endif %}
                                {% if form.monto_minimo.errors %}
                                <div class="invalid-feedback d-block">{{ form.monto_minimo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.monto_maximo.id_for_label }}" class="form-label required">
                                    {{ form.monto_maximo.label }}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.monto_maximo }}
                                </div>
                                {% if form.monto_maximo.help_text %}
                                <div class="help-text">{{ form.monto_maximo.help_text }}</div>
                                {% endif %}
                                {% if form.monto_maximo.errors %}
                                <div class="invalid-feedback d-block">{{ form.monto_maximo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Períodos -->
                <div class="form-section">
                    <h4 class="section-title">
                        <i class="fas fa-calendar-alt me-2"></i>Configuración de Períodos
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.numero_periodos_defecto.id_for_label }}" class="form-label required">
                                    {{ form.numero_periodos_defecto.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.numero_periodos_defecto }}
                                    <span class="input-group-text">meses</span>
                                </div>
                                {% if form.numero_periodos_defecto.help_text %}
                                <div class="help-text">{{ form.numero_periodos_defecto.help_text }}</div>
                                {% endif %}
                                {% if form.numero_periodos_defecto.errors %}
                                <div class="invalid-feedback d-block">{{ form.numero_periodos_defecto.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.periodos_minimos.id_for_label }}" class="form-label required">
                                    {{ form.periodos_minimos.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.periodos_minimos }}
                                    <span class="input-group-text">meses</span>
                                </div>
                                {% if form.periodos_minimos.help_text %}
                                <div class="help-text">{{ form.periodos_minimos.help_text }}</div>
                                {% endif %}
                                {% if form.periodos_minimos.errors %}
                                <div class="invalid-feedback d-block">{{ form.periodos_minimos.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.periodos_maximos.id_for_label }}" class="form-label required">
                                    {{ form.periodos_maximos.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.periodos_maximos }}
                                    <span class="input-group-text">meses</span>
                                </div>
                                {% if form.periodos_maximos.help_text %}
                                <div class="help-text">{{ form.periodos_maximos.help_text }}</div>
                                {% endif %}
                                {% if form.periodos_maximos.errors %}
                                <div class="invalid-feedback d-block">{{ form.periodos_maximos.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración Adicional -->
                <div class="form-section">
                    <h4 class="section-title">
                        <i class="fas fa-cogs me-2"></i>Configuración Adicional
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.comision_apertura.id_for_label }}" class="form-label">
                                    {{ form.comision_apertura.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.comision_apertura }}
                                    <span class="input-group-text">%</span>
                                </div>
                                {% if form.comision_apertura.help_text %}
                                <div class="help-text">{{ form.comision_apertura.help_text }}</div>
                                {% endif %}
                                {% if form.comision_apertura.errors %}
                                <div class="invalid-feedback d-block">{{ form.comision_apertura.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.gastos_administrativos.id_for_label }}" class="form-label">
                                    {{ form.gastos_administrativos.label }}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.gastos_administrativos }}
                                </div>
                                {% if form.gastos_administrativos.help_text %}
                                <div class="help-text">{{ form.gastos_administrativos.help_text }}</div>
                                {% endif %}
                                {% if form.gastos_administrativos.errors %}
                                <div class="invalid-feedback d-block">{{ form.gastos_administrativos.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.pagos_extra_permitidos.id_for_label }}" class="form-label">
                                    {{ form.pagos_extra_permitidos.label }}
                                </label>
                                <div class="form-check form-switch">
                                    {{ form.pagos_extra_permitidos }}
                                    <label class="form-check-label" for="{{ form.pagos_extra_permitidos.id_for_label }}">
                                        Permitir pagos adicionales
                                    </label>
                                </div>
                                {% if form.pagos_extra_permitidos.help_text %}
                                <div class="help-text">{{ form.pagos_extra_permitidos.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Errores generales del formulario -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                    <div>{{ error }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Botones de acción -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'microcreditos:configuracion_credito' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>{{ boton_texto }}
                    </button>
                </div>
            </div>

            <!-- Panel de Vista Previa -->
            <div class="col-lg-4">
                <div class="sticky-top" style="top: 1rem;">
                    <!-- Calculadora de Vista Previa -->
                    <div class="calculator-preview mb-3">
                        <h5 class="mb-3">
                            <i class="fas fa-calculator me-2"></i>Vista Previa de Cálculos
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label">Monto a simular</label>
                            <div class="input-group">
                                <span class="input-group-text text-dark">$</span>
                                <input type="number" id="preview-monto" class="form-control" value="25000" step="1000" min="1000">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Períodos</label>
                            <div class="input-group">
                                <input type="number" id="preview-periodos" class="form-control" value="12" min="1" max="60">
                                <span class="input-group-text text-dark">meses</span>
                            </div>
                        </div>
                        
                        <hr class="text-white-50">
                        
                        <div id="preview-results">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h6 class="mb-1">Cuota Mensual</h6>
                                    <h4 id="cuota-result">$---</h4>
                                </div>
                                <div class="col-6">
                                    <h6 class="mb-1">Total a Pagar</h6>
                                    <h4 id="total-result">$---</h4>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <small>Interés Total: <span id="interes-result">$---</span></small>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de Configuración -->
                    <div class="preview-box">
                        <h6 class="mb-3">
                            <i class="fas fa-eye me-2"></i>Resumen de Configuración
                        </h6>
                        
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Interés Anual:</strong></td>
                                <td><span id="summary-interes">15.00%</span></td>
                            </tr>
                            <tr>
                                <td><strong>Períodos Defecto:</strong></td>
                                <td><span id="summary-periodos">12 meses</span></td>
                            </tr>
                            <tr>
                                <td><strong>Rango Monto:</strong></td>
                                <td><span id="summary-monto">$1,000 - $100,000</span></td>
                            </tr>
                            <tr>
                                <td><strong>Tipo Cálculo:</strong></td>
                                <td><span id="summary-tipo">Estándar</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Función para actualizar la vista previa
    function updatePreview() {
        const interes = parseFloat($('#id_interes_anual').val()) || 15;
        const periodos = parseInt($('#id_numero_periodos_defecto').val()) || 12;
        const montoMin = parseFloat($('#id_monto_minimo').val()) || 1000;
        const montoMax = parseFloat($('#id_monto_maximo').val()) || 100000;
        const tipoCalculo = $('#id_tipo_calculo option:selected').text() || 'Estándar';
        
        // Actualizar resumen
        $('#summary-interes').text(interes.toFixed(2) + '%');
        $('#summary-periodos').text(periodos + ' meses');
        $('#summary-monto').text('$' + montoMin.toLocaleString() + ' - $' + montoMax.toLocaleString());
        $('#summary-tipo').text(tipoCalculo);
        
        // Calcular cuota de ejemplo
        calculatePreviewLoan();
    }
    
    // Función para calcular préstamo de ejemplo
    function calculatePreviewLoan() {
        const monto = parseFloat($('#preview-monto').val()) || 25000;
        const periodos = parseInt($('#preview-periodos').val()) || 12;
        const interes = parseFloat($('#id_interes_anual').val()) || 15;
        const tipoCalculo = $('#id_tipo_calculo').val() || 'estandar';
        
        // Validar rangos
        const montoMin = parseFloat($('#id_monto_minimo').val()) || 1000;
        const montoMax = parseFloat($('#id_monto_maximo').val()) || 100000;
        const periodosMin = parseInt($('#id_periodos_minimos').val()) || 1;
        const periodosMax = parseInt($('#id_periodos_maximos').val()) || 60;
        
        if (monto < montoMin || monto > montoMax || periodos < periodosMin || periodos > periodosMax) {
            $('#cuota-result').text('$---');
            $('#total-result').text('$---');
            $('#interes-result').text('$---');
            return;
        }
        
        let cuota;
        
        if (tipoCalculo === 'frances') {
            // Sistema francés
            const tasaMensual = (interes / 100) / 12;
            if (tasaMensual === 0) {
                cuota = monto / periodos;
            } else {
                const factor = (tasaMensual * Math.pow(1 + tasaMensual, periodos)) / (Math.pow(1 + tasaMensual, periodos) - 1);
                cuota = monto * factor;
            }
        } else {
            // Sistema estándar
            const interesTotal = monto * (interes / 100);
            cuota = (monto + interesTotal) / periodos;
        }
        
        const totalPagar = cuota * periodos;
        const interesTotal = totalPagar - monto;
        
        $('#cuota-result').text('$' + cuota.toFixed(2));
        $('#total-result').text('$' + totalPagar.toFixed(2));
        $('#interes-result').text('$' + interesTotal.toFixed(2));
    }
    
    // Eventos para actualizar la vista previa
    $('#id_interes_anual, #id_numero_periodos_defecto, #id_monto_minimo, #id_monto_maximo, #id_tipo_calculo, #id_periodos_minimos, #id_periodos_maximos').on('change keyup', updatePreview);
    $('#preview-monto, #preview-periodos').on('change keyup', calculatePreviewLoan);
    
    // Validaciones en tiempo real
    $('#id_monto_minimo, #id_monto_maximo').on('keyup change', function() {
        const min = parseFloat($('#id_monto_minimo').val());
        const max = parseFloat($('#id_monto_maximo').val());
        
        if (min && max && min >= max) {
            $('#id_monto_maximo').addClass('is-invalid');
            $('#id_monto_minimo').addClass('is-invalid');
        } else {
            $('#id_monto_maximo').removeClass('is-invalid');
            $('#id_monto_minimo').removeClass('is-invalid');
        }
    });
    
    $('#id_periodos_minimos, #id_periodos_maximos').on('keyup change', function() {
        const min = parseInt($('#id_periodos_minimos').val());
        const max = parseInt($('#id_periodos_maximos').val());
        
        if (min && max && min >= max) {
            $('#id_periodos_maximos').addClass('is-invalid');
            $('#id_periodos_minimos').addClass('is-invalid');
        } else {
            $('#id_periodos_maximos').removeClass('is-invalid');
            $('#id_periodos_minimos').removeClass('is-invalid');
        }
    });
    
    // Inicializar vista previa
    updatePreview();
    
    // Validación del formulario
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
});
</script>
{% endblock %}