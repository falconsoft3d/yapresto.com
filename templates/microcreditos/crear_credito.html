{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}
{% block page_title %}Nuevo Crédito{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .form-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    .section-title i {
        margin-right: 0.5rem;
        color: #007bff;
        font-size: 1.1rem;
    }
    
    .calculation-preview {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
        border-left: 4px solid #007bff;
    }
    
    .calculation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.3);
    }
    
    .calculation-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.1rem;
        color: #007bff;
    }
    
    .calculation-label {
        font-weight: 500;
        color: #495057;
    }
    
    .calculation-value {
        font-weight: 600;
        color: #28a745;
    }
    
    .config-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid #28a745;
    }
    
    .config-detail {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .config-detail:last-child {
        margin-bottom: 0;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        padding: 0.8rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,123,255,0.4);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        border: none;
        padding: 0.8rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(108,117,125,0.4);
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .alert-info {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        border: none;
        border-left: 4px solid #17a2b8;
    }
    
    .limits-info {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }
    
    .readonly-field {
        background-color: #f8f9fa !important;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-plus-circle me-2"></i>{{ titulo }}
        </h1>
        <p class="text-muted mb-0">Configure un nuevo crédito usando las configuraciones predefinidas</p>
    </div>
    <a href="{% url 'microcreditos:lista_prestamos' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver a Lista
    </a>
</div>

<!-- Información sobre configuraciones -->
<div class="alert alert-info mb-4">
    <div class="d-flex align-items-center">
        <i class="fas fa-info-circle me-2"></i>
        <div>
            <strong>Créditos con Configuración Automática</strong>
            <p class="mb-0 mt-1">Seleccione una configuración de crédito para calcular automáticamente las tasas, cuotas y validar límites según los parámetros predefinidos.</p>
        </div>
    </div>
</div>

<form method="post" id="creditoForm">
    {% csrf_token %}
    
    <div class="row">
        <!-- Información del Cliente y Configuración -->
        <div class="col-lg-6">
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-user"></i>Información del Cliente
                </h5>
                
                <div class="mb-3">
                    <label for="{{ form.cliente.id_for_label }}" class="form-label">Cliente</label>
                    {{ form.cliente }}
                    {% if form.cliente.errors %}
                        <div class="text-danger mt-1">{{ form.cliente.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.configuracion.id_for_label }}" class="form-label">Configuración de Crédito</label>
                    {{ form.configuracion }}
                    {% if form.configuracion.errors %}
                        <div class="text-danger mt-1">{{ form.configuracion.errors.0 }}</div>
                    {% endif %}
                    <div class="form-text">{{ form.configuracion.help_text }}</div>
                </div>
                
                <!-- Información de configuración seleccionada -->
                <div id="configInfo" class="config-info" style="display: none;">
                    <h6 class="mb-2"><i class="fas fa-cog me-1"></i> Detalles de la Configuración</h6>
                    <div class="config-detail">
                        <span>Tasa Anual:</span>
                        <span id="configTasa">-</span>
                    </div>
                    <div class="config-detail">
                        <span>Límites de Monto:</span>
                        <span id="configLimitesMonto">-</span>
                    </div>
                    <div class="config-detail">
                        <span>Límites de Períodos:</span>
                        <span id="configLimitesPeriodos">-</span>
                    </div>
                    <div class="config-detail">
                        <span>Tipo de Cálculo:</span>
                        <span id="configTipoCalculo">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Detalles del Crédito -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-calculator"></i>Detalles del Crédito
                </h5>
                
                <div class="mb-3">
                    <label for="{{ form.monto.id_for_label }}" class="form-label">Monto del Crédito</label>
                    {{ form.monto }}
                    {% if form.monto.errors %}
                        <div class="text-danger mt-1">{{ form.monto.errors.0 }}</div>
                    {% endif %}
                    <div id="montoLimits" class="limits-info" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <span id="montoLimitsText">Seleccione una configuración para ver los límites</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.plazo_meses.id_for_label }}" class="form-label">Plazo (meses)</label>
                    {{ form.plazo_meses }}
                    {% if form.plazo_meses.errors %}
                        <div class="text-danger mt-1">{{ form.plazo_meses.errors.0 }}</div>
                    {% endif %}
                    <div id="plazolimits" class="limits-info" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <span id="plazoLimitsText">Seleccione una configuración para ver los límites</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.tipo.id_for_label }}" class="form-label">Tipo de Crédito</label>
                    {{ form.tipo }}
                    {% if form.tipo.errors %}
                        <div class="text-danger mt-1">{{ form.tipo.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Cálculos Automáticos y Vista Previa -->
        <div class="col-lg-6">
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-chart-line"></i>Cálculos Automáticos
                </h5>
                
                <div class="mb-3">
                    <label for="{{ form.tasa_interes.id_for_label }}" class="form-label">Tasa de Interés Anual (%)</label>
                    {{ form.tasa_interes }}
                    <div class="form-text">{{ form.tasa_interes.help_text }}</div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.cuota_mensual.id_for_label }}" class="form-label">Cuota Mensual</label>
                    {{ form.cuota_mensual }}
                    <div class="form-text">{{ form.cuota_mensual.help_text }}</div>
                </div>
                
                <!-- Vista previa de cálculos -->
                <div id="calculationPreview" class="calculation-preview" style="display: none;">
                    <h6 class="mb-3"><i class="fas fa-calculator me-1"></i> Vista Previa del Crédito</h6>
                    
                    <div class="calculation-item">
                        <span class="calculation-label">Monto del Crédito:</span>
                        <span class="calculation-value" id="previewMonto">$0.00</span>
                    </div>
                    
                    <div class="calculation-item">
                        <span class="calculation-label">Tasa Mensual:</span>
                        <span class="calculation-value" id="previewTasaMensual">0.00%</span>
                    </div>
                    
                    <div class="calculation-item">
                        <span class="calculation-label">Comisión de Apertura:</span>
                        <span class="calculation-value" id="previewComision">$0.00</span>
                    </div>
                    
                    <div class="calculation-item">
                        <span class="calculation-label">Gastos Administrativos:</span>
                        <span class="calculation-value" id="previewGastos">$0.00</span>
                    </div>
                    
                    <div class="calculation-item">
                        <span class="calculation-label">Cuota Mensual:</span>
                        <span class="calculation-value" id="previewCuotaMensual">$0.00</span>
                    </div>
                    
                    <div class="calculation-item">
                        <span class="calculation-label">Total a Pagar:</span>
                        <span class="calculation-value" id="previewTotalPagar">$0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Información Adicional -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-clipboard"></i>Información Adicional
                </h5>
                
                <div class="mb-3">
                    <label for="{{ form.garantia.id_for_label }}" class="form-label">Garantía</label>
                    {{ form.garantia }}
                    {% if form.garantia.errors %}
                        <div class="text-danger mt-1">{{ form.garantia.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.observaciones.id_for_label }}" class="form-label">Observaciones</label>
                    {{ form.observaciones }}
                    {% if form.observaciones.errors %}
                        <div class="text-danger mt-1">{{ form.observaciones.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botones de Acción -->
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-save me-2"></i>Crear Crédito
                </button>
                <a href="{% url 'microcreditos:lista_prestamos' %}" class="btn btn-secondary">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
            </div>
            
            <div class="text-muted">
                <small><i class="fas fa-shield-alt me-1"></i> Los cálculos se realizan automáticamente según la configuración seleccionada</small>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let configuracionActual = null;
    
    // Manejar cambio de configuración
    $('#id_configuracion').change(function() {
        const configId = $(this).val();
        
        if (configId) {
            obtenerConfiguracion(configId);
        } else {
            ocultarInformacionConfiguracion();
        }
    });
    
    // Manejar cambios en monto y plazo para recalcular
    $('#id_monto, #id_plazo_meses').on('input', function() {
        if (configuracionActual) {
            calcularCuota();
        }
    });
    
    function obtenerConfiguracion(configId) {
        $.ajax({
            url: '{% url "microcreditos:obtener_configuracion_ajax" %}',
            data: { 'config_id': configId },
            success: function(response) {
                if (response.success) {
                    configuracionActual = response.data;
                    mostrarInformacionConfiguracion(response.data);
                    actualizarLimites(response.data);
                    calcularCuota();
                } else {
                    alert('Error al obtener la configuración: ' + response.error);
                }
            },
            error: function() {
                alert('Error al conectar con el servidor');
            }
        });
    }
    
    function mostrarInformacionConfiguracion(config) {
        $('#configTasa').text(config.interes_anual + '%');
        $('#configLimitesMonto').text('$' + config.monto_minimo.toLocaleString() + ' - $' + config.monto_maximo.toLocaleString());
        $('#configLimitesPeriodos').text(config.periodos_minimos + ' - ' + config.periodos_maximos + ' meses');
        $('#configTipoCalculo').text(config.tipo_calculo.charAt(0).toUpperCase() + config.tipo_calculo.slice(1));
        $('#configInfo').show();
        
        // Actualizar campos calculados
        $('#id_tasa_interes').val(config.interes_anual);
        $('#id_plazo_meses').attr('min', config.periodos_minimos).attr('max', config.periodos_maximos);
        $('#id_monto').attr('min', config.monto_minimo).attr('max', config.monto_maximo);
        
        // Si no hay valor en plazo, usar el por defecto
        if (!$('#id_plazo_meses').val()) {
            $('#id_plazo_meses').val(config.numero_periodos_defecto);
        }
    }
    
    function actualizarLimites(config) {
        $('#montoLimitsText').text(`Monto entre $${config.monto_minimo.toLocaleString()} y $${config.monto_maximo.toLocaleString()}`);
        $('#plazoLimitsText').text(`Plazo entre ${config.periodos_minimos} y ${config.periodos_maximos} meses`);
        $('#montoLimits, #plazolimits').show();
    }
    
    function calcularCuota() {
        const monto = parseFloat($('#id_monto').val());
        const plazo = parseInt($('#id_plazo_meses').val());
        
        if (monto && plazo && configuracionActual) {
            $.ajax({
                url: '{% url "microcreditos:calcular_cuota_ajax" %}',
                data: {
                    'monto': monto,
                    'periodos': plazo,
                    'config_id': $('#id_configuracion').val()
                },
                success: function(response) {
                    if (response.cuota) {
                        $('#id_cuota_mensual').val(response.cuota.toFixed(2));
                        mostrarVistaPrevia(monto, plazo, response);
                    }
                },
                error: function() {
                    console.log('Error al calcular la cuota');
                }
            });
        }
    }
    
    function mostrarVistaPrevia(monto, plazo, datosCalculo) {
        const comision = (monto * configuracionActual.comision_apertura / 100);
        const totalPagar = datosCalculo.cuota * plazo;
        
        $('#previewMonto').text('$' + monto.toLocaleString('es-ES', {minimumFractionDigits: 2}));
        $('#previewTasaMensual').text(configuracionActual.interes_mensual.toFixed(2) + '%');
        $('#previewComision').text('$' + comision.toLocaleString('es-ES', {minimumFractionDigits: 2}));
        $('#previewGastos').text('$' + configuracionActual.gastos_administrativos.toLocaleString('es-ES', {minimumFractionDigits: 2}));
        $('#previewCuotaMensual').text('$' + datosCalculo.cuota.toLocaleString('es-ES', {minimumFractionDigits: 2}));
        $('#previewTotalPagar').text('$' + totalPagar.toLocaleString('es-ES', {minimumFractionDigits: 2}));
        
        $('#calculationPreview').show();
    }
    
    function ocultarInformacionConfiguracion() {
        $('#configInfo').hide();
        $('#montoLimits, #plazolimits').hide();
        $('#calculationPreview').hide();
        $('#id_tasa_interes, #id_cuota_mensual').val('');
        configuracionActual = null;
    }
    
    // Animaciones de entrada
    $('.form-section').each(function(index) {
        $(this).delay(index * 100).fadeIn(600);
    });
});
</script>
{% endblock %}