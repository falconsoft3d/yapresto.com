{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Créditos - YaPresto{% endblock %}
{% block page_title %}Gestión de Créditos{% endblock %}

{% block extra_css %}
<style>
    .table th {
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateX(2px);
        transition: all 0.2s ease;
    }
    
    .table tbody tr[style*="cursor: pointer"]:hover {
        background-color: #e3f2fd !important;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .table tbody tr[style*="cursor: pointer"]:active {
        transform: translateX(2px);
        background-color: #bbdefb !important;
    }
    
    .avatar-sm {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
    }
    
    .btn-group .btn {
        transition: all 0.2s ease;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.4rem 0.8rem;
    }
    
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .bg-light.text-dark {
        background-color: #f8f9fa !important;
        color: #495057 !important;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h4 class="mb-0 me-3">Lista de Créditos</h4>
        <span class="badge bg-primary">{{ prestamos|length }} créditos</span>
    </div>
    <a href="{% url 'microcreditos:crear_credito' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Nuevo Crédito
    </a>
</div>

<!-- Filtros -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Estado</label>
                <select name="estado" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="aprobado" {% if request.GET.estado == 'aprobado' %}selected{% endif %}>Aprobado</option>
                    <option value="activo" {% if request.GET.estado == 'activo' %}selected{% endif %}>Activo</option>
                    <option value="completado" {% if request.GET.estado == 'completado' %}selected{% endif %}>Completado</option>
                    <option value="vencido" {% if request.GET.estado == 'vencido' %}selected{% endif %}>Vencido</option>
                    <option value="rechazado" {% if request.GET.estado == 'rechazado' %}selected{% endif %}>Rechazado</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text" name="search" class="form-control" placeholder="Cliente, ID..." value="{{ request.GET.search }}">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary me-2">Filtrar</button>
                <a href="{% url 'microcreditos:lista_prestamos' %}" class="btn btn-outline-secondary">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<!-- Estadísticas rápidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white border-0">
            <div class="card-body text-center">
                <i class="bi bi-credit-card-2-front display-6 mb-2"></i>
                <h4 class="mb-1">{{ prestamos|length }}</h4>
                <small class="text-white-50">Total Créditos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white border-0">
            <div class="card-body text-center">
                <i class="bi bi-check-circle display-6 mb-2"></i>
                <h4 class="mb-1">
                    {% with activos=prestamos|length %}{{ activos }}{% endwith %}
                </h4>
                <small class="text-white-50">Activos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark border-0">
            <div class="card-body text-center">
                <i class="bi bi-clock display-6 mb-2"></i>
                <h4 class="mb-1">
                    {% with pendientes=prestamos|length %}{{ pendientes }}{% endwith %}
                </h4>
                <small class="text-dark">Pendientes</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white border-0">
            <div class="card-body text-center">
                <i class="bi bi-cash-stack display-6 mb-2"></i>
                <h4 class="mb-1">
                    ${% with total_monto=0 %}{% for p in prestamos %}{% with total_monto=total_monto|add:p.monto %}{% endwith %}{% endfor %}{{ total_monto|floatformat:0 }}{% endwith %}
                </h4>
                <small class="text-white-50">Monto Total</small>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Créditos -->
{% if prestamos %}
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-4 py-3">ID</th>
                        <th class="py-3">Cliente</th>
                        <th class="py-3">Monto</th>
                        <th class="py-3">Plazo</th>
                        <th class="py-3">Tasa</th>
                        <th class="py-3">Cuota</th>
                        <th class="py-3">Estado</th>
                        <th class="py-3">Configuración</th>
                        <th class="py-3">Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prestamo in prestamos %}
                    <tr style="cursor: pointer;" onclick="window.location.href='{% url 'microcreditos:detalle_prestamo' prestamo.pk %}'">
                        <td class="px-4 py-3">
                            <span class="fw-bold text-primary">#{{ prestamo.id }}</span>
                        </td>
                        <td class="py-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center me-2">
                                    <i class="bi bi-person text-muted"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ prestamo.cliente.nombre_completo }}</div>
                                    <small class="text-muted">{{ prestamo.cliente.cedula }}</small>
                                </div>
                            </div>
                        </td>
                        <td class="py-3">
                            <span class="fw-bold text-success">${{ prestamo.monto|floatformat:0 }}</span>
                        </td>
                        <td class="py-3">
                            <span class="badge bg-light text-dark">{{ prestamo.plazo_meses }} meses</span>
                        </td>
                        <td class="py-3">
                            <span class="text-info fw-bold">{{ prestamo.tasa_interes }}%</span>
                        </td>
                        <td class="py-3">
                            <span class="fw-bold text-primary">${{ prestamo.cuota_mensual|floatformat:2 }}</span>
                        </td>
                        <td class="py-3">
                            <span class="badge 
                                {% if prestamo.estado == 'activo' %}bg-success
                                {% elif prestamo.estado == 'pendiente' %}bg-warning text-dark
                                {% elif prestamo.estado == 'aprobado' %}bg-info
                                {% elif prestamo.estado == 'completado' %}bg-primary
                                {% elif prestamo.estado == 'vencido' %}bg-danger
                                {% elif prestamo.estado == 'rechazado' %}bg-secondary
                                {% else %}bg-light text-dark{% endif %}">
                                {{ prestamo.get_estado_display }}
                            </span>
                        </td>
                        <td class="py-3">
                            {% if prestamo.configuracion_credito %}
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-gear-fill text-success me-1"></i>
                                    <small class="text-success fw-bold">{{ prestamo.configuracion_credito.nombre }}</small>
                                </div>
                            {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-dash-circle me-1"></i>
                                    <small>Manual</small>
                                </span>
                            {% endif %}
                        </td>
                        <td class="py-3">
                            <div>
                                <small class="text-muted d-block">{{ prestamo.fecha_solicitud|date:"d/m/Y" }}</small>
                                <small class="text-muted">{{ prestamo.fecha_solicitud|date:"H:i" }}</small>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <div class="mb-4">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
    </div>
    <h5 class="text-muted">No hay créditos registrados</h5>
    <p class="text-muted">Comience creando el primer crédito del sistema.</p>
    <a href="{% url 'microcreditos:crear_credito' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Crear Primer Crédito
    </a>
</div>
{% endif %}

{% endblock %}