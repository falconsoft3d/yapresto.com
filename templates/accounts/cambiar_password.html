{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - YaPresto{% endblock %}
{% block page_title %}Cambiar Mi Contraseña{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="mb-3">
            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Volver al Perfil
            </a>
        </div>
        
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-lock me-2"></i>
                    Cambiar Mi Contraseña
                </h5>
                <small>Actualiza tu contraseña para mayor seguridad</small>
            </div>
            <div class="card-body">
                <!-- Mensajes de éxito/error -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Información de seguridad -->
                <div class="alert alert-info">
                    <h6><i class="bi bi-shield-check me-2"></i>Recomendaciones de Seguridad</h6>
                    <ul class="mb-0">
                        <li>Usa al menos 8 caracteres</li>
                        <li>Combina letras mayúsculas y minúsculas</li>
                        <li>Incluye números y símbolos</li>
                        <li>No uses información personal</li>
                        <li>No reutilices contraseñas anteriores</li>
                    </ul>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <!-- Contraseña actual -->
                            <div class="mb-4">
                                <label for="{{ form.old_password.id_for_label }}" class="form-label">
                                    <i class="bi bi-key me-2"></i>{{ form.old_password.label }}
                                </label>
                                {{ form.old_password }}
                                {% if form.old_password.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.old_password.errors %}
                                            <div><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Ingresa tu contraseña actual para confirmar tu identidad
                                </div>
                            </div>
                            
                            <!-- Nueva contraseña -->
                            <div class="mb-4">
                                <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                                    <i class="bi bi-lock me-2"></i>{{ form.new_password1.label }}
                                </label>
                                {{ form.new_password1 }}
                                {% if form.new_password1.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.new_password1.errors %}
                                            <div><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Tu nueva contraseña debe ser segura y fácil de recordar
                                </div>
                                <!-- Indicador de fortaleza de contraseña -->
                                <div class="password-strength mt-2" id="password-strength" style="display: none;">
                                    <small class="text-muted">Fortaleza de contraseña:</small>
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" id="strength-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="strength-text" class="text-muted"></small>
                                </div>
                            </div>
                            
                            <!-- Confirmar nueva contraseña -->
                            <div class="mb-4">
                                <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                                    <i class="bi bi-lock-fill me-2"></i>{{ form.new_password2.label }}
                                </label>
                                {{ form.new_password2 }}
                                {% if form.new_password2.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.new_password2.errors %}
                                            <div><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Repite exactamente la misma contraseña para confirmar
                                </div>
                            </div>
                            
                            <!-- Información adicional del usuario -->
                            <div class="card border-secondary mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="bi bi-person-circle me-2"></i>
                                        Información de Seguridad
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2">
                                                <strong><i class="bi bi-person me-1"></i>Usuario:</strong> 
                                                {{ user.username }}
                                            </p>
                                            <p class="mb-2">
                                                <strong><i class="bi bi-clock me-1"></i>Último acceso:</strong> 
                                                {% if user.last_login %}
                                                    {{ user.last_login|date:"d/m/Y H:i" }}
                                                {% else %}
                                                    <span class="text-muted">Nunca</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2">
                                                <strong><i class="bi bi-shield-check me-1"></i>Estado:</strong> 
                                                <span class="badge bg-{% if user.is_active %}success{% else %}secondary{% endif %}">
                                                    {% if user.is_active %}Activa{% else %}Inactiva{% endif %}
                                                </span>
                                            </p>
                                            <p class="mb-2">
                                                <strong><i class="bi bi-award me-1"></i>Rol:</strong> 
                                                <span class="badge bg-primary">
                                                    {% if user.perfil %}
                                                        {{ user.perfil.get_rol_display }}
                                                    {% else %}
                                                        Usuario
                                                    {% endif %}
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-center">
                        <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary me-3">
                            <i class="bi bi-x-circle me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-check-circle me-2"></i>Cambiar Contraseña
                        </button>
                    </div>
                </form>
                
                <!-- Advertencia importante -->
                <div class="alert alert-warning mt-4">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Importante</h6>
                    <p class="mb-0">
                        Después de cambiar tu contraseña, permanecerás conectado en esta sesión. 
                        Sin embargo, necesitarás usar la nueva contraseña para futuros inicios de sesión.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Indicador de fortaleza de contraseña
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthIndicator = document.getElementById('password-strength');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    if (passwordField) {
        passwordField.addEventListener('input', function() {
            const password = this.value;
            
            if (password.length > 0) {
                strengthIndicator.style.display = 'block';
                const strength = calculatePasswordStrength(password);
                updateStrengthIndicator(strength, password.length);
                
                // Cambiar borde del campo según fortaleza
                this.classList.remove('border-danger', 'border-warning', 'border-success');
                if (strength.score < 3) {
                    this.classList.add('border-danger');
                } else if (strength.score < 5) {
                    this.classList.add('border-warning');
                } else {
                    this.classList.add('border-success');
                }
            } else {
                strengthIndicator.style.display = 'none';
                this.classList.remove('border-danger', 'border-warning', 'border-success');
            }
        });
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        // Longitud
        if (password.length >= 8) {
            score += 2;
        } else {
            feedback.push('Mínimo 8 caracteres');
        }
        
        if (password.length >= 12) score++;
        
        // Caracteres
        if (/[a-z]/.test(password)) {
            score++;
        } else {
            feedback.push('Minúsculas');
        }
        
        if (/[A-Z]/.test(password)) {
            score++;
        } else {
            feedback.push('Mayúsculas');
        }
        
        if (/[0-9]/.test(password)) {
            score++;
        } else {
            feedback.push('Números');
        }
        
        if (/[^a-zA-Z0-9]/.test(password)) {
            score++;
        } else {
            feedback.push('Símbolos');
        }
        
        return { score, feedback };
    }
    
    function updateStrengthIndicator(strength, length) {
        const percentage = Math.min((strength.score / 6) * 100, 100);
        strengthBar.style.width = percentage + '%';
        
        let className = 'bg-danger';
        let text = 'Muy débil';
        
        if (strength.score >= 6) {
            className = 'bg-success';
            text = 'Muy fuerte';
        } else if (strength.score >= 4) {
            className = 'bg-warning';
            text = 'Fuerte';
        } else if (strength.score >= 3) {
            className = 'bg-info';
            text = 'Media';
        } else if (strength.score >= 1) {
            className = 'bg-warning';
            text = 'Débil';
        }
        
        strengthBar.className = 'progress-bar ' + className;
        
        if (strength.feedback.length > 0) {
            text += ' - Faltan: ' + strength.feedback.join(', ');
        }
        
        strengthText.textContent = text;
        strengthText.className = 'text-muted small';
    }
});
</script>

<style>
.form-control.border-danger {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-control.border-warning {
    border-color: #ffc107 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

.form-control.border-success {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

.form-control:focus.border-danger {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-control:focus.border-warning {
    border-color: #ffc107 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

.form-control:focus.border-success {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}
</style>
{% endblock %}